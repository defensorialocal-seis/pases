<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de pases Operador</title>
<style>
  :root{
    --bg:#a3c8ff;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#2563eb;
    --danger:#ef4444;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      linear-gradient(180deg, rgba(37,99,235,0.06), transparent 120px),
      var(--bg);
    color:#0f172a;
    padding:18px;
    -webkit-font-smoothing:antialiased;
  }

  header{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:14px;
  }
  header h1{margin:0;font-size:1.15rem;}
  header .controls{display:flex;gap:8px;align-items:center;}

  .container{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:16px;
    align-items:start;
  }

  /* Left panel (form) */
  .card{
    background:var(--card);
    border-radius:10px;
    padding:14px;
    box-shadow: 0 6px 18px rgba(12,18,35,0.06);
  }
  form .row{
    display:flex;
    gap:8px;
    margin-bottom:8px;
    align-items:center;
  }
  label{font-size:0.8rem;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="date"], select, textarea{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #e6edf3;
    background:transparent;
    font-size:0.95rem;
  }
  textarea{min-height:70px;resize:vertical;padding-top:10px}
  .small{font-size:0.85rem;color:var(--muted)}
  button{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
  button.danger{background:var(--danger)}
  .actions{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:10px}

  /* Right panel (table/list) */
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .table{
    width:100%;
    border-collapse:collapse;
    border-radius:10px;
    overflow:hidden;
  }
  .table thead{
    background:#0f172a; /* azul oscuro sólido */
    color:white;
    font-weight:700;
  }
  .table th, .table td{
    padding:10px 12px;
    border-bottom:1px solid #eef2f7;
    text-align:left;
    vertical-align:top;
    font-size:0.95rem;
  }
  .table tbody tr:hover{background:#fbfdff}
  .chip{
    display:inline-block;padding:6px 8px;border-radius:999px;background:#eef2ff;color:#0b4bd8;font-size:0.85rem;margin-right:6px;
  }
  .muted{color:var(--muted);font-size:0.9rem}

  .flex{display:flex;gap:8px;align-items:center}
  .grow{flex:1}

  /* Responsive */
  @media (max-width:980px){
    .container{grid-template-columns:1fr; }
    header{gap:8px;flex-direction:column;align-items:flex-start}
  }

  /* modal */
  .modal-back{
    position:fixed;inset:0;background:rgba(3,7,18,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
  }
  .modal{
    width:100%;max-width:820px;background:var(--card);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(2,6,23,0.5)
  }
  .modal.show{display:flex}

  /* printable view tweak */
  @media print{
    body{background:white;padding:0}
    header, .actions, .toolbar, .modal-back{display:none}
    .card{box-shadow:none;border-radius:0}
    .table th, .table td{font-size:12pt}
  }
</style>
</head>
<body>
<header>
  <div>
    <h1>Registro de Pases Operador</h1>
    <div class="small">Operador Defensoria Civil y Comercial 6 Poder Judicial de Misiones</div>
  </div>
  <div class="controls"></div>
</header>

<div class="container">
  <!-- FORM -->
  <aside class="card" aria-label="Formulario de registro">
    <form id="cause-form">
      <input type="hidden" id="cause-id">
      <label for="expediente">Número de Expte *</label>
      <input id="expediente" type="text" placeholder="Ej: 12345/2025" required>

      <label for="caratula">Carátula *</label>
      <input id="caratula" type="text" placeholder="Carátula del expediente" required>

      <label for="tipo">Tipo de proceso *</label>
      <select id="tipo" required>
        <option value="">-- Seleccionar --</option>
        <option value="Civil">Civil</option>
        <option value="Laboral">Laboral</option>
        <option value="Familia">Familia</option>
        <option value="Violencia Familiar">Violencia Familiar</option>
        <option value="Administrativo: Cejume">Administrativo: Cejume</option>
        <option value="Administrativo: DEUT">Administrativo: DEUT</option>
      </select>

      <label for="personal">Personal asignado *</label>
      <select id="personal" required>
        <option value="">-- Seleccionar --</option>
        <option>Bazante Nadia Romina</option>
        <option>Boillat Cesar Enrique</option>
        <option>Cardozo Maria Raquel</option>
        <option>Cedron Noelia Aurora</option>
        <option>Corrales Alicia Mariela</option>
        <option>Escobar Monica Graciela</option>
        <option>Fioravante Romulo</option>
        <option>Gonzalez Alberto Misael</option>
        <option>Gonzalez Juan Jose</option>
        <option>Gudiño Natalia Esther</option>
        <option>Magnani Enzo Luciano</option>
        <option>Pablos Patricia</option>
        <option>Palacios Ana Gabriela</option>
        <option>Ortega Lucia Noemi</option>
        <option>Ramos Marcelo Gustavo</option>
        <option>Riveros Patricia Soledad</option>
        <option>Sosa Rita Cecilia</option>
      </select>

      <label for="fecha-pase">Fecha de pase a proveer *</label>
      <input id="fecha-pase" type="date" required>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7">

      <label>Devolución a Mesa de Entradas</label>
      <input id="devol-motivo" type="text" placeholder="Motivo (opcional)">
      <input id="devol-fecha" type="date" placeholder="Fecha devolución">

      <label style="margin-top:8px">Remisión a otra Defensoría</label>
      <input id="rem-detalle" type="text" placeholder="Detalle (opcional)">
      <input id="rem-fecha" type="date" placeholder="Fecha remisión">

      <label style="margin-top:8px">Causas vinculadas por cuerda</label>
      <select id="vinculadas" multiple></select>
      <div class="small" style="margin-bottom:8px">Mantén Ctrl/Cmd para seleccionar múltiples. Selecciona aquí expedientes ya registrados.</div>

      <label>Causas acumuladas</label>
      <select id="acumuladas" multiple></select>
      <div class="small">Se guardan como relaciones internas entre expedientes.</div>

      <div class="actions">
        <div style="display:flex;gap:8px">
          <button type="submit" id="save-btn">Guardar</button>
          <button type="button" id="reset-btn" class="ghost">Limpiar</button>
        </div>
        <div class="muted" id="form-tip">Campos con * obligatorios</div>
      </div>
    </form>
  </aside>

  <!-- LIST -->
  <main>
    <div class="card">
      <div class="toolbar">
        <input id="search" type="text" placeholder="Buscar por expte, carátula, personal..." class="grow" />
        <select id="filter-tipo"><option value="">Todos los tipos</option>
          <option>Civil</option><option>Laboral</option><option>Familia</option><option>Violencia Familiar</option>
          <option>Administrativo: Cejume</option><option>Administrativo: DEUT</option>
        </select>
        <select id="filter-personal"><option value="">Todos los personales</option></select>
        <label for="filter-date-from" class="small" style="margin:0">Desde</label>
        <input id="filter-date-from" type="date" style="width:140px">
        <label for="filter-date-to" class="small" style="margin:0">Hasta</label>
        <input id="filter-date-to" type="date" style="width:140px">
        <button id="print-all" class="ghost">Imprimir lista</button>
      </div>

      <div style="overflow:auto">
      <table class="table" id="causes-table">
        <thead>
          <tr>
            <th>Expte</th>
            <th>Carátula / Tipo</th>
            <th>Personal / Pase</th>
            <th>Vinculadas / Acumuladas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
      </div>
    </div>
  </main>
</div>

<!-- Modal para ver/imprimir registro -->
<div class="modal-back" id="modal-back">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="modal-title" style="margin:0">Vista de Causa</h3>
      <div style="display:flex;gap:8px">
        <button id="modal-print" class="ghost">Imprimir</button>
        <button id="modal-close" class="ghost">Cerrar</button>
      </div>
    </div>
    <div id="modal-content" style="font-size:0.95rem;line-height:1.5"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<script>
/* =========================
   CONFIGURACIÓN FIREBASE
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDRO3TWNgHDUpOqB0FfyquxRdRJdg-WFNM",
  authDomain: "pase-operador.firebaseapp.com",
  projectId: "pase-operador",
  storageBucket: "pase-operador.firebasestorage.app",
  messagingSenderId: "1059978202214",
  appId: "1:1059978202214:web:c70563ac36ce2025fc71a7",
  databaseURL: "https://pase-operador-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let causes = [];

const $ = sel => document.querySelector(sel);
const formatDate = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
};
const parseDate = s => (s ? new Date(s) : null);

function attachRealtimeListener(){
  db.ref('causes').on('value', snap => {
    const val = snap.val() || {};
    causes = Object.values(val).sort((a,b)=> (a.expediente||'').localeCompare(b.expediente||''));
    refreshSelects();
    refreshTable();
  });
}

async function saveCause(obj){ await db.ref('causes/'+obj.id).set(obj); }
async function deleteCause(id){ await db.ref('causes/'+id).remove(); }

const inputs = {
  id: $('#cause-id'), expediente: $('#expediente'), caratula: $('#caratula'),
  tipo: $('#tipo'), personal: $('#personal'), fechaPase: $('#fecha-pase'),
  devolMotivo: $('#devol-motivo'), devolFecha: $('#devol-fecha'),
  remDetalle: $('#rem-detalle'), remFecha: $('#rem-fecha'),
  vinculadas: $('#vinculadas'), acumuladas: $('#acumuladas')
};

function refreshSelects(){
  const options = causes.map(c => ({value:c.id,text:`${c.expediente} — ${c.caratula}`}));
  [inputs.vinculadas,inputs.acumuladas].forEach(sel=>{
    sel.innerHTML=''; options.forEach(o=>{let opt=document.createElement('option');opt.value=o.value;opt.textContent=o.text;sel.appendChild(opt);});
  });
  const personalFilter=$('#filter-personal');
  personalFilter.innerHTML='<option value="">Todos los personales</option>';
  [...new Set(causes.map(c=>(c.personal||'').trim()).filter(Boolean))].sort().forEach(p=>{
    let opt=document.createElement('option');opt.value=p;opt.textContent=p;personalFilter.appendChild(opt);
  });
}

function byId(id){ return causes.find(c=>c.id===id); }
function labelsFromIds(arr){
  if(!Array.isArray(arr) || !arr.length) return '—';
  return arr.map(id=>{
    const c = byId(id);
    return c ? `${c.expediente}` : id;
  }).join(', ');
}

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

function renderRow(c){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><strong>${escapeHtml(c.expediente)}</strong></td>
    <td><div>${escapeHtml(c.caratula)||'<span class="muted">—</span>'}</div><div class="small chip">${escapeHtml(c.tipo)}</div></td>
    <td><div>${escapeHtml(c.personal)||'<span class="muted">—</span>'}</div><div class="small">${formatDate(c.fechaPase)}</div></td>
    <td>
      <div class="small"><strong>Vinc:</strong> ${labelsFromIds(c.vinculadas)}</div>
      <div class="small" style="margin-top:6px"><strong>Acum:</strong> ${labelsFromIds(c.acumuladas)}</div>
    </td>
    <td>
      <div class="flex">
        <button class="ghost btn-view" data-id="${c.id}">Ver</button>
        <button class="ghost btn-edit" data-id="${c.id}">Editar</button>
        <button class="danger btn-delete" data-id="${c.id}">Eliminar</button>
      </div>
    </td>`;
  return tr;
}

function getFilters(){
  return {
    q: ($('#search').value||'').toLowerCase().trim(),
    tipo: $('#filter-tipo').value,
    personal: $('#filter-personal').value,
    from: $('#filter-date-from').value ? parseDate($('#filter-date-from').value) : null,
    to: $('#filter-date-to').value ? new Date(new Date($('#filter-date-to').value).getTime()+24*60*60*1000-1) : null // inclusive
  };
}

function applyFilters(list){
  const {q,tipo,personal,from,to} = getFilters();
  return list.filter(c=>{
    const hayQ = !q || [c.expediente,c.caratula,c.personal].some(v=> String(v||'').toLowerCase().includes(q));
    const hayTipo = !tipo || c.tipo===tipo;
    const hayPers = !personal || c.personal===personal;
    const f = c.fechaPase ? new Date(c.fechaPase) : null;
    const hayDesde = !from || (f && f >= from);
    const hayHasta = !to || (f && f <= to);
    return hayQ && hayTipo && hayPers && hayDesde && hayHasta;
  });
}

function refreshTable(){
  const tbody=$('#table-body');tbody.innerHTML='';
  const filtered = applyFilters(causes);
  filtered.forEach(c=>tbody.appendChild(renderRow(c)));
}

function selectedValues(selectEl){
  return Array.from(selectEl.selectedOptions).map(o=>o.value);
}

function setMultiSelect(selectEl, values){
  const set = new Set(values||[]);
  Array.from(selectEl.options).forEach(opt=>{ opt.selected = set.has(opt.value); });
}

function clearForm(){
  inputs.id.value='';
  inputs.expediente.value='';
  inputs.caratula.value='';
  inputs.tipo.value='';
  inputs.personal.value='';
  inputs.fechaPase.value='';
  inputs.devolMotivo.value='';
  inputs.devolFecha.value='';
  inputs.remDetalle.value='';
  inputs.remFecha.value='';
  setMultiSelect(inputs.vinculadas,[]);
  setMultiSelect(inputs.acumuladas,[]);
  $('#save-btn').textContent='Guardar';
}

function populateForm(c){
  inputs.id.value = c.id;
  inputs.expediente.value = c.expediente||'';
  inputs.caratula.value = c.caratula||'';
  inputs.tipo.value = c.tipo||'';
  inputs.personal.value = c.personal||'';
  inputs.fechaPase.value = c.fechaPase ? new Date(c.fechaPase).toISOString().slice(0,10) : '';
  inputs.devolMotivo.value = c.devolMotivo||'';
  inputs.devolFecha.value = c.devolFecha ? new Date(c.devolFecha).toISOString().slice(0,10) : '';
  inputs.remDetalle.value = c.remDetalle||'';
  inputs.remFecha.value = c.remFecha ? new Date(c.remFecha).toISOString().slice(0,10) : '';
  setMultiSelect(inputs.vinculadas, c.vinculadas||[]);
  setMultiSelect(inputs.acumuladas, c.acumuladas||[]);
  $('#save-btn').textContent='Actualizar';
}

function printHtml(html){
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Impresión</title>
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:24px} h1{font-size:18px;margin:0 0 14px} .row{margin:6px 0} .muted{color:#64748b} .chip{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px} table{width:100%;border-collapse:collapse;margin-top:10px} td{padding:6px 8px;vertical-align:top;border-bottom:1px solid #f1f5f9}</style>
  </head><body>${html}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
}

/* =========================
   EVENTOS
   ========================= */

// Guardar
$('#cause-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const isEdit = Boolean(inputs.id.value);
  const id = isEdit ? inputs.id.value : db.ref('causes').push().key;

  const obj = {
    id,
    expediente: inputs.expediente.value.trim(),
    caratula: inputs.caratula.value.trim(),
    tipo: inputs.tipo.value,
    personal: inputs.personal.value,
    fechaPase: inputs.fechaPase.value ? new Date(inputs.fechaPase.value).toISOString() : null,
    devolMotivo: inputs.devolMotivo.value.trim() || null,
    devolFecha: inputs.devolFecha.value ? new Date(inputs.devolFecha.value).toISOString() : null,
    remDetalle: inputs.remDetalle.value.trim() || null,
    remFecha: inputs.remFecha.value ? new Date(inputs.remFecha.value).toISOString() : null,
    vinculadas: selectedValues(inputs.vinculadas),
    acumuladas: selectedValues(inputs.acumuladas),
    updatedAt: new Date().toISOString(),
  };
  if(!isEdit){ obj.createdAt = obj.updatedAt; }

  if(!obj.expediente || !obj.caratula || !obj.tipo || !obj.personal || !obj.fechaPase){
    alert('Completá los campos obligatorios.');
    return;
  }

  await saveCause(obj);
  clearForm();
});

// Limpiar
$('#reset-btn').addEventListener('click', ()=> clearForm());

// Delegación de acciones en tabla
$('#table-body').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  const c = byId(id);
  if(!c) return;
  if(btn.classList.contains('btn-edit')){
    populateForm(c);
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(btn.classList.contains('btn-delete')){
    if(confirm('¿Eliminar el registro? Esta acción no se puede deshacer.')){
      await deleteCause(id);
    }
  } else if(btn.classList.contains('btn-view')){
    const html = `
      <h1>Expediente ${escapeHtml(c.expediente)}</h1>
      <div class="row"><strong>Carátula:</strong> ${escapeHtml(c.caratula)||'—'}</div>
      <div class="row"><strong>Tipo:</strong> <span class="chip">${escapeHtml(c.tipo)}</span></div>
      <div class="row"><strong>Personal:</strong> ${escapeHtml(c.personal)||'—'}</div>
      <div class="row"><strong>Fecha de pase:</strong> ${formatDate(c.fechaPase)}</div>
      <div class="row"><strong>Devolución:</strong> ${escapeHtml(c.devolMotivo)||'—'} ${c.devolFecha?`(${formatDate(c.devolFecha)})`:''}</div>
      <div class="row"><strong>Remisión:</strong> ${escapeHtml(c.remDetalle)||'—'} ${c.remFecha?`(${formatDate(c.remFecha)})`:''}</div>
      <div class="row"><strong>Vinculadas:</strong> ${labelsFromIds(c.vinculadas)}</div>
      <div class="row"><strong>Acumuladas:</strong> ${labelsFromIds(c.acumuladas)}</div>
    `;
    $('#modal-content').innerHTML = html;
    $('#modal-back').classList.add('show');
    $('#modal-print').onclick = ()=> printHtml(html);
  }
});

// Modal cerrar
$('#modal-close').addEventListener('click', ()=> $('#modal-back').classList.remove('show'));
$('#modal-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-back'){ $('#modal-back').classList.remove('show'); } });

// Filtros
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
['#search','#filter-tipo','#filter-personal','#filter-date-from','#filter-date-to'].forEach(sel=>{
  const el = $(sel);
  const evt = sel==='#search' ? 'input' : 'change';
  const handler = sel==='#search' ? debounce(refreshTable,150) : refreshTable;
  el.addEventListener(evt, handler);
});

// Imprimir lista
$('#print-all').addEventListener('click', ()=> window.print());

(function init(){ attachRealtimeListener(); })();
</script>
</body>
</html>
