<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operador. Pase y Asignación de Expedientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding-top: 70px; }
        .card { transition: transform 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-actions { position: absolute; top: 10px; right: 10px; opacity: 0; transition: opacity 0.3s; }
        .card:hover .card-actions { opacity: 1; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">Operador. Pase y Asignación de Expedientes</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title mb-0">Listado de Expedientes con pase/asignación</h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#expedienteModal">
                    <i class="fas fa-plus me-1"></i> Crear Nuevo Expediente
                </button>
                <button class="btn btn-outline-secondary" id="btnActualizar">
                    <i class="fas fa-sync-alt me-1"></i> Actualizar
                </button>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por expediente, usuario...">
                </div>
                <div class="col-md-3">
                    <input type="text" id="expedienteAsignadoFilter" class="form-control" placeholder="Filtrar por Expediente Asignado">
                </div>
                <div class="col-md-3">
                    <select id="userFilter" class="form-select">
                        <option value="">Filtrar por Usuario</option>
                        <option>Bazante Nadia Romina</option>
                        <option>Boillat Cesar Enrique</option>
                        <option>Cardozo Maria Raquel</option>
                        <option>Cedron Noelia Aurora</option>
                        <option>Corrales Alicia Mariela</option>
                        <option>Escobar Monica Graciela</option>
                        <option>Fioravante Romulo</option>
                        <option>Gonzalez Alberto Misael</option>
                        <option>Gonzalez Juan Jose</option>
                        <option>Gudiño Natalia Esther</option>
                        <option>Magnani Enzo Luciano</option>
                        <option>Pablos Patricia</option>
                        <option>Palacios Ana Gabriela</option>
                        <option>Ortega Lucia Noemi</option>
                        <option>Ramos Marcelo Gustavo</option>
                        <option>Riveros Patricia Soledad</option>
                        <option>Sosa Rita Cecilia</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">Fecha de Pase</span>
                        <input type="date" id="dateFilterStart" class="form-control">
                        <span class="input-group-text">a</span>
                        <input type="date" id="dateFilterEnd" class="form-control">
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary" id="btnSearch"><i class="fas fa-search"></i> Buscar</button>
                </div>
            </div>
        </div>

        <div id="expedientesContainer">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando expedientes...</p>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Sistema</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="expedienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expedienteModalTitle">Nuevo Expediente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="expedienteForm">
                        <input type="hidden" id="expedienteId">
                        <div class="mb-3">
                            <label for="numCausa" class="form-label">Número de Causa *</label>
                            <input type="text" class="form-control" id="numCausa" required>
                        </div>
                        <div class="mb-3">
                            <label for="usuarioAsignado" class="form-label">Usuario Asignado *</label>
                            <select class="form-select" id="usuarioAsignado" required>
                                <option value="">-- Seleccionar --</option>
                                <option>Bazante Nadia Romina</option>
                                <option>Boillat Cesar Enrique</option>
                                <option>Cardozo Maria Raquel</option>
                                <option>Cedron Noelia Aurora</option>
                                <option>Corrales Alicia Mariela</option>
                                <option>Escobar Monica Graciela</option>
                                <option>Fioravante Romulo</option>
                                <option>Gonzalez Alberto Misael</option>
                                <option>Gonzalez Juan Jose</option>
                                <option>Gudiño Natalia Esther</option>
                                <option>Magnani Enzo Luciano</option>
                                <option>Pablos Patricia</option>
                                <option>Palacios Ana Gabriela</option>
                                <option>Ortega Lucia Noemi</option>
                                <option>Ramos Marcelo Gustavo</option>
                                <option>Riveros Patricia Soledad</option>
                                <option>Sosa Rita Cecilia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="fechaPase" class="form-label">Fecha de Pase *</label>
                            <input type="date" class="form-control" id="fechaPase" required>
                        </div>
                        <div class="mb-3">
                            <label for="otrosExpedientesCuerda" class="form-label">Otros Expedientes por Cuerda</label>
                            <textarea class="form-control" id="otrosExpedientesCuerda" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="otrosExpedientesAcumulados" class="form-label">Otros Expedientes Acumulados</label>
                            <textarea class="form-control" id="otrosExpedientesAcumulados" rows="2"></textarea>
                        </div>
                        <hr>
                        <h6 class="mb-3">Motivos Especiales (opcional)</h6>
                        <div class="mb-3">
                            <label for="devolucionMotivo" class="form-label">Devolución a Mesa de Entradas (Motivo)</label>
                            <textarea class="form-control" id="devolucionMotivo" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="remisionMotivo" class="form-label">Remisión a otra Defensoría (Motivo)</label>
                            <textarea class="form-control" id="remisionMotivo" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveExpedienteBtn">
                        <span id="expedienteSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Guardar Expediente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewExpedienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewExpedienteTitle">Detalles del Expediente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewExpedienteBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-info" id="printExpedienteBtn">
                        <i class="fas fa-print me-1"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDgxLS98sk6GkLrjMu3BVS2cmZ9exdh4dY",
            authDomain: "atencion-publico-def6.firebaseapp.com",
            databaseURL: "https://atencion-publico-def6-default-rtdb.firebaseio.com",
            projectId: "atencion-publico-def6",
            storageBucket: "atencion-publico-def6.firebasestorage.app",
            messagingSenderId: "1052433106688",
            appId: "1:1052433106688:web:8ac3e144bcf377ac4b55e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const expedientesRef = db.collection('causas');
        const expedientesContainer = document.getElementById('expedientesContainer');
        const expedienteForm = document.getElementById('expedienteForm');
        const saveExpedienteBtn = document.getElementById('saveExpedienteBtn');
        const expedienteSpinner = document.getElementById('expedienteSpinner');
        const expedienteModal = document.getElementById('expedienteModal');
        const viewExpedienteModal = document.getElementById('viewExpedienteModal');
        const printExpedienteBtn = document.getElementById('printExpedienteBtn');

        // Filtros
        const searchInput = document.getElementById('searchInput');
        const expedienteAsignadoFilter = document.getElementById('expedienteAsignadoFilter');
        const userFilter = document.getElementById('userFilter');
        const dateFilterStart = document.getElementById('dateFilterStart');
        const dateFilterEnd = document.getElementById('dateFilterEnd');
        const btnSearch = document.getElementById('btnSearch');

        // Función para formatear la fecha a DD/MM/AAAA
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // Función para guardar o actualizar un expediente
        saveExpedienteBtn.addEventListener('click', async () => {
            const expedienteId = document.getElementById('expedienteId').value;
            const numCausa = document.getElementById('numCausa').value;
            const usuarioAsignado = document.getElementById('usuarioAsignado').value;
            const fechaPase = document.getElementById('fechaPase').value;
            const otrosExpedientesCuerda = document.getElementById('otrosExpedientesCuerda').value;
            const otrosExpedientesAcumulados = document.getElementById('otrosExpedientesAcumulados').value;
            const devolucionMotivo = document.getElementById('devolucionMotivo').value;
            const remisionMotivo = document.getElementById('remisionMotivo').value;

            if (!numCausa || !usuarioAsignado || !fechaPase) {
                alert('Por favor, complete todos los campos obligatorios.');
                return;
            }

            expedienteSpinner.style.display = 'inline-block';
            saveExpedienteBtn.disabled = true;

            try {
                if (expedienteId) {
                    await expedientesRef.doc(expedienteId).update({
                        numCausa,
                        usuarioAsignado,
                        fechaPase,
                        otrosExpedientesCuerda,
                        otrosExpedientesAcumulados,
                        devolucionMotivo,
                        remisionMotivo
                    });
                    alert('Expediente actualizado con éxito!');
                } else {
                    await expedientesRef.add({
                        numCausa,
                        usuarioAsignado,
                        fechaPase,
                        otrosExpedientesCuerda,
                        otrosExpedientesAcumulados,
                        devolucionMotivo,
                        remisionMotivo,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Expediente guardado con éxito!');
                }
                
                const modalInstance = bootstrap.Modal.getInstance(expedienteModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                expedienteForm.reset();
                loadExpedientes();
            } catch (error) {
                console.error("Error al guardar el expediente: ", error);
                alert("Error al guardar el expediente: " + error.message);
            } finally {
                expedienteSpinner.style.display = 'none';
                saveExpedienteBtn.disabled = false;
            }
        });

        // Evento para limpiar el formulario al abrir el modal de nuevo registro
        expedienteModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            if (button && button.dataset.bsToggle === 'modal' && button.dataset.bsTarget === '#expedienteModal') {
                expedienteForm.reset();
                document.getElementById('expedienteId').value = '';
                document.getElementById('expedienteModalTitle').textContent = 'Nuevo Expediente';
                document.getElementById('saveExpedienteBtn').textContent = 'Guardar Expediente';
            }
        });

        // Función para cargar y mostrar los expedientes con filtros
        async function loadExpedientes() {
            expedientesContainer.innerHTML = `<div class="text-center py-4">
                                                 <div class="spinner-border text-primary" role="status">
                                                   <span class="visually-hidden">Cargando...</span>
                                                 </div>
                                                 <p class="mt-2">Cargando expedientes...</p>
                                               </div>`;

            const searchString = searchInput.value.toLowerCase();
            const expedienteAsignadoString = expedienteAsignadoFilter.value.toLowerCase();
            const userString = userFilter.value;
            const startDate = dateFilterStart.value;
            const endDate = dateFilterEnd.value;
            let query = expedientesRef.orderBy('timestamp', 'desc');

            if (userString) {
                query = query.where('usuarioAsignado', '==', userString);
            }

            if (startDate) {
                query = query.where('fechaPase', '>=', startDate);
            }
            if (endDate) {
                query = query.where('fechaPase', '<=', endDate);
            }

            try {
                const snapshot = await query.get();
                expedientesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    expedientesContainer.innerHTML = '<p class="text-center text-muted mt-5">No hay expedientes registrados que coincidan con los criterios de búsqueda.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Filtrado en el cliente para "Búsqueda general" y "Expediente asignado"
                    const matchesSearch = !searchString || 
                                          data.numCausa.toLowerCase().includes(searchString) ||
                                          data.usuarioAsignado.toLowerCase().includes(searchString);

                    const matchesExpedienteAsignado = !expedienteAsignadoString || data.numCausa.toLowerCase().includes(expedienteAsignadoString);

                    if (matchesSearch && matchesExpedienteAsignado) {
                        const cardHtml = `
                            <div class="card mb-3 expediente-card" data-id="${doc.id}">
                                <div class="card-body">
                                    <div class="card-actions">
                                        <button class="btn btn-warning btn-sm edit-btn" data-id="${doc.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-btn" data-id="${doc.id}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    <h5 class="card-title expediente-num-causa">Expediente: ${data.numCausa}</h5>
                                    <p class="card-text">
                                        <strong>Usuario Asignado:</strong> ${data.usuarioAsignado}<br>
                                        <strong>Fecha de Pase:</strong> ${formatDate(data.fechaPase)}<br>
                                        <strong>Otros Expedientes:</strong> ${data.otrosExpedientesCuerda || 'N/A'}<br>
                                    </p>
                                </div>
                            </div>
                        `;
                        expedientesContainer.innerHTML += cardHtml;
                    }
                });
                
                if (expedientesContainer.innerHTML === '') {
                    expedientesContainer.innerHTML = '<p class="text-center text-muted mt-5">No se encontraron expedientes con la búsqueda.</p>';
                }

                expedientesContainer.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editExpediente(e.currentTarget.dataset.id);
                    });
                });

                expedientesContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteExpediente(e.currentTarget.dataset.id);
                    });
                });
                
                expedientesContainer.querySelectorAll('.expediente-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        viewExpediente(e.currentTarget.dataset.id);
                    });
                });

            } catch (error) {
                console.error("Error al cargar los expedientes:", error);
                expedientesContainer.innerHTML = `<p class="text-center text-danger mt-5">Error al cargar expedientes: ${error.message}</p>`;
            }
        }
        
        // Función para poblar el filtro de usuarios (no se usa, la lista es estática)
        async function populateUserFilter() {
        }

        // Función para editar un expediente
        async function editExpediente(id) {
            try {
                const doc = await expedientesRef.doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('expedienteId').value = doc.id;
                    document.getElementById('numCausa').value = data.numCausa;
                    document.getElementById('usuarioAsignado').value = data.usuarioAsignado;
                    document.getElementById('fechaPase').value = data.fechaPase;
                    document.getElementById('otrosExpedientesCuerda').value = data.otrosExpedientesCuerda || '';
                    document.getElementById('otrosExpedientesAcumulados').value = data.otrosExpedientesAcumulados || '';
                    document.getElementById('devolucionMotivo').value = data.devolucionMotivo || '';
                    document.getElementById('remisionMotivo').value = data.remisionMotivo || '';
                    
                    document.getElementById('expedienteModalTitle').textContent = 'Editar Expediente';
                    document.getElementById('saveExpedienteBtn').textContent = 'Actualizar Expediente';
                    
                    const modal = new bootstrap.Modal(expedienteModal);
                    modal.show();
                } else {
                    alert('Expediente no encontrado.');
                }
            } catch (error) {
                console.error("Error al obtener el expediente para editar: ", error);
            }
        }
        
        // Función para eliminar un expediente
        async function deleteExpediente(id) {
            if (confirm('¿Está seguro de que desea eliminar este expediente?')) {
                try {
                    await expedientesRef.doc(id).delete();
                    alert('Expediente eliminado con éxito!');
                    loadExpedientes();
                } catch (error) {
                    console.error("Error al eliminar el expediente: ", error);
                    alert("Error al eliminar el expediente: " + error.message);
                }
            }
        }

        // Función para ver el expediente en un modal informativo
        async function viewExpediente(id) {
            try {
                const doc = await expedientesRef.doc(id).get();
                if (doc.exists) {
                    const data = doc.data();
                    const viewBody = document.getElementById('viewExpedienteBody');
                    viewBody.innerHTML = `
                        <div id="printContent">
                            <p><strong>Número de Causa:</strong> ${data.numCausa}</p>
                            <p><strong>Usuario Asignado:</strong> ${data.usuarioAsignado}</p>
                            <p><strong>Fecha de Pase:</strong> ${formatDate(data.fechaPase)}</p>
                            <p><strong>Otros Expedientes por Cuerda:</strong> ${data.otrosExpedientesCuerda || 'N/A'}</p>
                            <p><strong>Otros Expedientes Acumulados:</strong> ${data.otrosExpedientesAcumulados || 'N/A'}</p>
                            <hr>
                            <h6>Motivos Especiales</h6>
                            <p><strong>Devolución a Mesa de Entradas:</strong> ${data.devolucionMotivo || 'N/A'}</p>
                            <p><strong>Remisión a otra Defensoría:</strong> ${data.remisionMotivo || 'N/A'}</p>
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(viewExpedienteModal);
                    modal.show();
                    
                    printExpedienteBtn.onclick = () => imprimirExpediente(data);
                } else {
                    alert('Expediente no encontrado.');
                }
            } catch (error) {
                console.error("Error al ver el expediente: ", error);
            }
        }
        
        // Función para imprimir el contenido del modal
        function imprimirExpediente(expediente) {
            const printContent = `
                <h2>Detalles del Expediente</h2>
                <p><strong>Número de Causa:</strong> ${expediente.numCausa}</p>
                <p><strong>Usuario Asignado:</strong> ${expediente.usuarioAsignado}</p>
                <p><strong>Fecha de Pase:</strong> ${formatDate(expediente.fechaPase)}</p>
                <p><strong>Otros Expedientes por Cuerda:</strong> ${expediente.otrosExpedientesCuerda || 'N/A'}</p>
                <p><strong>Otros Expedientes Acumulados:</strong> ${expediente.otrosExpedientesAcumulados || 'N/A'}</p>
                <hr>
                <h6>Motivos Especiales</h6>
                <p><strong>Devolución a Mesa de Entradas:</strong> ${expediente.devolucionMotivo || 'N/A'}</p>
                <p><strong>Remisión a otra Defensoría:</strong> ${expediente.remisionMotivo || 'N/A'}</p>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Imprimir Expediente</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-5">');
            printWindow.document.write(printContent);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            
            printWindow.onload = () => {
                printWindow.print();
            };
        }
        
        // Asignar eventos a los filtros
        btnSearch.addEventListener('click', loadExpedientes);

        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                loadExpedientes();
            }
        });

        expedienteAsignadoFilter.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                loadExpedientes();
            }
        });

        userFilter.addEventListener('change', loadExpedientes);
        dateFilterStart.addEventListener('change', loadExpedientes);
        dateFilterEnd.addEventListener('change', loadExpedientes);

        // Llamar a las funciones de carga al iniciar la página
        document.addEventListener('DOMContentLoaded', () => {
            loadExpedientes();
            populateUserFilter();
        });
        
        // Asignar el evento al botón de actualizar
        const btnActualizar = document.getElementById('btnActualizar');
        btnActualizar.addEventListener('click', loadExpedientes);
    </script>
</body>
</html>
